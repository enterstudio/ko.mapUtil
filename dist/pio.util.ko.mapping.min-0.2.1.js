/*! PIO.util.ko.mapping - v0.2.1 - 2013-05-06
* https://github.com/micahasmith/ko.mapUtil
* Copyright (c) 2013 Micah Smith; Licensed MIT */
var PIO=PIO||{};PIO.util=PIO.util||{},PIO.util.ko=PIO.util.ko||{},PIO.util.ko.mapUtil=function(r,e){var n=function(){var n=this,i=function(r){return function(i,t){return n.map(e.defaults({source:i,destination:t},r))}},t=function(r,n){return function(i){return r(e.defaults({source:i},n))}},u=function(n){var t=n.source,u=n.destination,o=n.predicate,a=(n.recurse||!0,n.builder||function(r){return r}),s=n.mapper||i(n),c=Boolean(o),l=[];return u||(u=[]),r.isObservable(u)&&e.isArray(u())||(u=r.observableArray(u)),c||u.removeAll(),u().length?(e.forEach(t,function(r){var n=a(r),i=e(u()).find(function(r){return o(r,n)});i?s(n,i):l.push(n)}),e(l).forEach(function(r){u.push(r)})):e(t).forEach(function(r){u.push(a(r))}),u};this.build=function(i){var t=i.destination||{},u=i.source,o=i.recurse||!0;return e.forEach(u,function(u,a){e.isFunction(u)||(t[a]=e.isArray(u)?0===u.length?r.observableArray([]):o&&(e.isObject(u[0])||e.isPlainObject(u[0]))?r.observableArray(e.map(u,function(r){return n.build(e.defaults({source:r},i))})):r.observableArray(u):e.isPlainObject(u)||e.isObject(u)?o?n.build(e.defaults({source:u},i)):r.observable(u):r.observable(u))}),t.__kom=!0,t},this.map=function(i){var o=i.source,a=i.destination,s=Boolean(i.recurse||!0),c=i.build,l=i.builder;return l=c===!1?function(r){return r}:i.builder?function(r){var e=i.builder(r);return e.__kom=!0,e}:t(n.build,e.defaults({oItem:{}},i)),e.isArray(o)||r.isObservable(o)&&e.isArray(o())?u(i):(e.has(o,"__kom")||(o=l(o)),a?(e.forEach(o,function(t,u){if(e.has(a,u)){var c,l,f=function(r){return r()},b=function(r,e){r(e)};e.isFunction(t)?r.isWriteableObservable(t)&&(c=f,l=b):e.isObject(t)&&s&&n.map(e.defaults({source:o[u],destination:a[u]},i)),Boolean(c)&&Boolean(l)&&l(a[u],c(o[u]))}}),void 0):l(a))}};return new n}(ko,_);