/*! PIO.util.ko.maputil - v0.3.0 - 2013-05-07
* https://github.com/micahasmith/ko.mapUtil
* Copyright (c) 2013 Micah Smith; Licensed MIT */
var PIO=PIO||{};PIO.util=PIO.util||{},PIO.util.ko=PIO.util.ko||{},PIO.util.ko.mapUtil=function(r,n){var e=function(){var e=this,i=function(r){return function(i,t){return e.map(n.defaults({source:i,destination:t},r))}},t=function(r,e){return function(i){return r(n.defaults({source:i},e))}},o=function(r,e){return r&&n.contains(r,e)?!0:!1},u=function(e){var t=e.source,o=e.destination,u=e.predicate,a=(e.recurse||!0,e.builder||function(r){return r}),s=e.mapper||i(e),c=(e.ignore,Boolean(u)),l=[];return o||(o=[]),r.isObservable(o)&&n.isArray(o())||(o=r.observableArray(o)),c||o.removeAll(),o().length?(n.forEach(t,function(r){var e=a(r),i=n(o()).find(function(r){return u(r,e)});i?s(e,i):l.push(e)}),n(l).forEach(function(r){o.push(r)})):n(t).forEach(function(r){o.push(a(r))}),o};this.build=function(i){var t=i.destination||{},u=i.source,a=i.recurse||!0,s=i.ignore,c=i.options;return n.forEach(u,function(u,l){o(s,l)||n.isFunction(u)||(t[l]=n.isArray(u)?0===u.length?r.observableArray([]):a&&(n.isObject(u[0])||n.isPlainObject(u[0]))?r.observableArray(n.map(u,function(r){return c?e.build(n.defaults(n.defaults({source:r},c[l]),i)):e.build(n.defaults({source:r},i))})):r.observableArray(u):n.isPlainObject(u)||n.isObject(u)?a?e.build(n.defaults({source:u},i)):r.observable(u):r.observable(u))}),t.__kom=!0,t},this.map=function(i){var a=i.source,s=i.destination,c=Boolean(i.recurse||!0),l=i.build,f=i.builder,b=i.ignore,d=i.options;return f=l===!1?function(r){return r.__kom=!0,r}:i.builder?function(r){var n=i.builder(r);return n.__kom=!0,n}:t(e.build,n.defaults({destination:void 0},i)),n.isArray(a)||r.isObservable(a)&&n.isArray(a())?u(i):(n.has(a,"__kom")&&s||(a=f(a)),s?(n.forEach(a,function(t,u){if(n.has(s,u)&&!o(b,u)){var l,f,v=function(r){return r()},h=function(r,n){r(n)};n.isFunction(t)?r.isWriteableObservable(t)&&(l=v,f=h):n.isObject(t)&&(t.__kom=!0,c&&(d&&d[u]?n.defaults(n.defaults({source:a[u],destination:s[u]},d[u]),i):e.map(n.defaults({source:a[u],destination:s[u]},i)))),Boolean(l)&&Boolean(f)&&f(s[u],l(a[u]))}}),void 0):a)}};return new e}(ko,_);